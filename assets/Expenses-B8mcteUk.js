import{u as z,b as P,c as O,j as e}from"./vendor-query-BBSsXiBS.js";import{u as te,a as f}from"./vendor-react-Cua_SOQ2.js";import{c as ne,s as g,u as ie,a as le,b as v,L as d,C as N,S as C,d as _,e as w,f as D,g as m,I as E,B as oe,x as ce,z as o}from"./index-De75nt2H.js";import{u as de,S as ue}from"./useProperties-CW1cgYmm.js";import{u as xe}from"./useUnits-BY5QSTqu.js";import{S as me,A as pe,D as he,R as $}from"./AppSidebar-BMrVA_Jp.js";import{T as ge}from"./TopBar-ioa75gCp.js";import{T as je}from"./textarea-BksRswRQ.js";import{B as ye}from"./badge-COPlmVyV.js";import{C as A,a as B,b as H,c as K}from"./card-nJjNL--Z.js";import{D as fe,a as be,b as ve,c as Ne,d as Ce}from"./dialog-CU0zoF6x.js";import{T as _e,A as we,a as De,b as Se,c as Ee,d as Ae,e as Te,f as qe,g as ke}from"./alert-dialog-CYp6Xfqu.js";import{T as Fe,a as Pe,b as Q,c as p,d as Oe,e as h}from"./table-D-R88hVk.js";import{C as R}from"./checkbox-DQT27pwU.js";import{S as Me}from"./useAuthenticatedUser-DxFjEeTf.js";import{P as Ie}from"./plus-CuU8l0SB.js";import{F as Le}from"./filter-Cb7ugw8G.js";import{S as Ve}from"./search-CHJz-TVc.js";import{C as Ue}from"./calendar-DyfbDffr.js";import{f as F}from"./format-BJjq1L2l.js";import"./vendor-ui-Dpa_eFEd.js";import"./vendor-supabase-By2EX_dj.js";import"./scroll-area-DovF1kS9.js";const $e=ne("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),T={repairs:{label:"Repairs & Maintenance",color:"bg-red-600"},utilities:{label:"Utilities",color:"bg-blue-600"},taxes:{label:"Property Taxes",color:"bg-yellow-600"},insurance:{label:"Insurance",color:"bg-green-600"},management:{label:"Management Fees",color:"bg-purple-600"},mortgage:{label:"Mortgage/Loan",color:"bg-indigo-600"},hoa:{label:"HOA Fees",color:"bg-pink-600"},landscaping:{label:"Landscaping",color:"bg-emerald-600"},cleaning:{label:"Cleaning",color:"bg-cyan-600"},legal:{label:"Legal Fees",color:"bg-orange-600"},advertising:{label:"Advertising",color:"bg-teal-600"},supplies:{label:"Supplies",color:"bg-amber-600"},other:{label:"Other",color:"bg-gray-600"}};function Be(a){return z({queryKey:["expenses",a],queryFn:async()=>{let r=g.from("expenses").select(`
          *,
          property:properties(id, name, address),
          unit:units(id, unit_number)
        `).order("expense_date",{ascending:!1});a?.propertyId&&(r=r.eq("property_id",a.propertyId)),a?.category&&(r=r.eq("category",a.category)),a?.startDate&&(r=r.gte("expense_date",a.startDate)),a?.endDate&&(r=r.lte("expense_date",a.endDate)),a?.search&&(r=r.or(`description.ilike.%${a.search}%,vendor.ilike.%${a.search}%`));const{data:t,error:i}=await r;if(i)throw i;return t}})}function He(){const a=P();return O({mutationFn:async r=>{const{data:t}=await g.auth.getUser(),{data:i,error:c}=await g.from("expenses").insert({...r,created_by:t.user?.id}).select().single();if(c)throw c;return i},onSuccess:()=>{a.invalidateQueries({queryKey:["expenses"]})}})}function Ke(){const a=P();return O({mutationFn:async({id:r,...t})=>{const{data:i,error:c}=await g.from("expenses").update(t).eq("id",r).select().single();if(c)throw c;return i},onSuccess:(r,t)=>{a.invalidateQueries({queryKey:["expenses"]}),a.invalidateQueries({queryKey:["expense",t.id]})}})}function Qe(){const a=P();return O({mutationFn:async r=>{const{error:t}=await g.from("expenses").delete().eq("id",r);if(t)throw t},onSuccess:()=>{a.invalidateQueries({queryKey:["expenses"]})}})}function Re(a,r){const t=new Date().getFullYear();return z({queryKey:["expenseSummary",a,t],queryFn:async()=>{let i=g.from("expenses").select("category, amount").gte("expense_date",`${t}-01-01`).lte("expense_date",`${t}-12-31`);a&&(i=i.eq("property_id",a));const{data:c,error:u}=await i;if(u)throw u;const x={repairs:0,utilities:0,taxes:0,insurance:0,management:0,mortgage:0,hoa:0,landscaping:0,cleaning:0,legal:0,advertising:0,supplies:0,other:0};let j=0;return c?.forEach(b=>{const y=b.category;x[y]=(x[y]||0)+Number(b.amount),j+=Number(b.amount)}),{byCategory:x,total:j,year:t}}})}const ze=o.object({property_id:o.string().min(1,"Property is required"),unit_id:o.string().optional(),category:o.string().min(1,"Category is required"),amount:o.coerce.number().min(.01,"Amount must be greater than 0"),expense_date:o.string().min(1,"Date is required"),description:o.string().optional(),vendor:o.string().optional(),is_recurring:o.boolean().default(!1),recurring_frequency:o.string().optional(),is_tax_deductible:o.boolean().default(!0),notes:o.string().optional()});function js(){const a=te(),{toast:r}=ie(),[t,i]=f.useState({}),[c,u]=f.useState(!1),[x,j]=f.useState(null),[b,y]=f.useState(!1),[M,I]=f.useState(null),{data:L,isLoading:Y}=Be(t),{data:V}=de(),{data:S}=Re(t.propertyId),{mutate:G,isPending:J}=He(),{mutate:W,isPending:X}=Ke(),{mutate:Z}=Qe(),l=le({resolver:ce(ze),defaultValues:{property_id:"",category:"",amount:0,expense_date:F(new Date,"yyyy-MM-dd"),is_recurring:!1,is_tax_deductible:!0}}),ee=l.watch("property_id"),{data:q}=xe(ee||void 0);f.useEffect(()=>{(async()=>{const{data:{session:n}}=await g.auth.getSession();n||a("/auth",{replace:!0})})()},[a]);const U=s=>{s?(j(s),l.reset({property_id:s.property_id,unit_id:s.unit_id||void 0,category:s.category,amount:s.amount,expense_date:s.expense_date,description:s.description||"",vendor:s.vendor||"",is_recurring:s.is_recurring,recurring_frequency:s.recurring_frequency||void 0,is_tax_deductible:s.is_tax_deductible,notes:s.notes||""})):(j(null),l.reset({property_id:t.propertyId||"",category:"",amount:0,expense_date:F(new Date,"yyyy-MM-dd"),is_recurring:!1,is_tax_deductible:!0})),u(!0)},se=s=>{x?W({id:x.id,...s,category:s.category,unit_id:s.unit_id||null},{onSuccess:()=>{r({title:"Expense updated"}),u(!1),j(null)},onError:()=>{r({title:"Failed to update expense",variant:"destructive"})}}):G({...s,category:s.category,unit_id:s.unit_id||null},{onSuccess:()=>{r({title:"Expense created"}),u(!1)},onError:()=>{r({title:"Failed to create expense",variant:"destructive"})}})},ae=()=>{M&&Z(M,{onSuccess:()=>{r({title:"Expense deleted"}),y(!1),I(null)},onError:()=>{r({title:"Failed to delete expense",variant:"destructive"})}})},re=S?Object.entries(S.byCategory).filter(([,s])=>s>0).sort(([,s],[,n])=>n-s).slice(0,4):[];return e.jsxs(me,{children:[e.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[e.jsx(pe,{}),e.jsxs("main",{className:"flex-1 overflow-auto",children:[e.jsx(ge,{}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Expenses"}),e.jsx("p",{className:"text-muted-foreground",children:"Track and manage property expenses"})]}),e.jsxs(fe,{open:c,onOpenChange:u,children:[e.jsx(be,{asChild:!0,children:e.jsxs(v,{onClick:()=>U(),children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Add Expense"]})}),e.jsxs(ve,{className:"max-w-lg",children:[e.jsx(Ne,{children:e.jsx(Ce,{children:x?"Edit Expense":"Add Expense"})}),e.jsxs("form",{onSubmit:l.handleSubmit(se),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Property *"}),e.jsx(N,{name:"property_id",control:l.control,render:({field:s})=>e.jsxs(C,{value:s.value,onValueChange:s.onChange,children:[e.jsx(_,{children:e.jsx(w,{placeholder:"Select property"})}),e.jsx(D,{children:V?.map(n=>e.jsx(m,{value:n.id,children:n.name},n.id))})]})})]}),q&&q.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Unit (optional)"}),e.jsx(N,{name:"unit_id",control:l.control,render:({field:s})=>e.jsxs(C,{value:s.value||"",onValueChange:n=>s.onChange(n||void 0),children:[e.jsx(_,{children:e.jsx(w,{placeholder:"All units / Property-wide"})}),e.jsxs(D,{children:[e.jsx(m,{value:"",children:"Property-wide"}),q.map(n=>e.jsxs(m,{value:n.id,children:["Unit ",n.unit_number]},n.id))]})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Category *"}),e.jsx(N,{name:"category",control:l.control,render:({field:s})=>e.jsxs(C,{value:s.value,onValueChange:s.onChange,children:[e.jsx(_,{children:e.jsx(w,{placeholder:"Select category"})}),e.jsx(D,{children:Object.entries(T).map(([n,k])=>e.jsx(m,{value:n,children:k.label},n))})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Amount *"}),e.jsx(E,{type:"number",step:"0.01",placeholder:"0.00",...l.register("amount")})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Date *"}),e.jsx(E,{type:"date",...l.register("expense_date")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Vendor"}),e.jsx(E,{placeholder:"Vendor name",...l.register("vendor")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Description"}),e.jsx(je,{placeholder:"Describe the expense...",...l.register("description")})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{name:"is_tax_deductible",control:l.control,render:({field:s})=>e.jsx(R,{id:"tax_deductible",checked:s.value,onCheckedChange:s.onChange})}),e.jsx(d,{htmlFor:"tax_deductible",className:"text-sm",children:"Tax deductible"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{name:"is_recurring",control:l.control,render:({field:s})=>e.jsx(R,{id:"recurring",checked:s.value,onCheckedChange:s.onChange})}),e.jsx(d,{htmlFor:"recurring",className:"text-sm",children:"Recurring expense"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:()=>u(!1),children:"Cancel"}),e.jsxs(v,{type:"submit",disabled:J||X,children:[x?"Update":"Add"," Expense"]})]})]})]})]})]}),e.jsxs("div",{className:"grid gap-4 grid-cols-2 md:grid-cols-5",children:[e.jsxs(A,{children:[e.jsx(B,{className:"pb-2",children:e.jsxs(H,{className:"text-sm font-medium text-muted-foreground",children:["Total (",S?.year,")"]})}),e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-red-500"}),e.jsxs("span",{className:"text-2xl font-bold",children:["$",S?.total.toLocaleString()||"0"]})]})})]}),re.map(([s,n])=>{const k=T[s];return e.jsxs(A,{children:[e.jsx(B,{className:"pb-2",children:e.jsx(H,{className:"text-sm font-medium text-muted-foreground",children:k.label})}),e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-2xl font-bold",children:["$",n.toLocaleString()]})]})})]},s)})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Filters:"})]}),e.jsxs(C,{value:t.propertyId||"",onValueChange:s=>i({...t,propertyId:s||void 0}),children:[e.jsxs(_,{className:"w-[180px]",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),e.jsx(w,{placeholder:"All Properties"})]}),e.jsxs(D,{children:[e.jsx(m,{value:"",children:"All Properties"}),V?.map(s=>e.jsx(m,{value:s.id,children:s.name},s.id))]})]}),e.jsxs(C,{value:t.category||"",onValueChange:s=>i({...t,category:s||void 0}),children:[e.jsxs(_,{className:"w-[180px]",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),e.jsx(w,{placeholder:"All Categories"})]}),e.jsxs(D,{children:[e.jsx(m,{value:"",children:"All Categories"}),Object.entries(T).map(([s,n])=>e.jsx(m,{value:s,children:n.label},s))]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ve,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(E,{placeholder:"Search...",value:t.search||"",onChange:s=>i({...t,search:s.target.value||void 0}),className:"pl-10 w-[200px]"})]})]}),Y?e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(s=>e.jsx(Me,{className:"h-12 w-full"},s))}):L?.length===0?e.jsxs(A,{className:"p-12 text-center",children:[e.jsx($,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("h3",{className:"text-lg font-medium",children:"No expenses found"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Add your first expense to start tracking"})]}):e.jsx(A,{children:e.jsxs(Fe,{children:[e.jsx(Pe,{children:e.jsxs(Q,{children:[e.jsx(p,{children:"Date"}),e.jsx(p,{children:"Property"}),e.jsx(p,{children:"Category"}),e.jsx(p,{children:"Vendor"}),e.jsx(p,{children:"Description"}),e.jsx(p,{className:"text-right",children:"Amount"}),e.jsx(p,{className:"w-[80px]"})]})}),e.jsx(Oe,{children:L?.map(s=>{const n=T[s.category];return e.jsxs(Q,{children:[e.jsx(h,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"}),F(new Date(s.expense_date),"MMM d, yyyy")]})}),e.jsx(h,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.property?.name}),s.unit&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Unit ",s.unit.unit_number]})]})}),e.jsx(h,{children:e.jsx(ye,{className:`${n?.color} text-white`,children:n?.label})}),e.jsx(h,{children:s.vendor||"-"}),e.jsx(h,{className:"max-w-[200px] truncate",children:s.description||"-"}),e.jsxs(h,{className:"text-right font-medium",children:["$",s.amount.toLocaleString()]}),e.jsx(h,{children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>U(s),children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>{I(s.id),y(!0)},children:e.jsx(_e,{className:"h-4 w-4 text-red-500"})})]})})]},s.id)})})]})})]})]})]}),e.jsx(we,{open:b,onOpenChange:y,children:e.jsxs(De,{children:[e.jsxs(Se,{children:[e.jsx(Ee,{children:"Delete Expense"}),e.jsx(Ae,{children:"Are you sure you want to delete this expense? This action cannot be undone."})]}),e.jsxs(Te,{children:[e.jsx(qe,{children:"Cancel"}),e.jsx(ke,{onClick:ae,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})}export{js as default};
