import{j as e,u as N}from"./vendor-query-BBSsXiBS.js";import{a as n,u as K,f as X}from"./vendor-react-Cua_SOQ2.js";import{c as Y,h as E,s as l,J as b,L as M,I as U,b as Q,S as F,d as A,e as q,f as L,g as S}from"./index-De75nt2H.js";import{A as k,a as P,P as W}from"./PaymentHistory-TKtHj9sV.js";import{C as R,a as T,b as D,d as G,c as I,e as Z}from"./card-nJjNL--Z.js";import{u as ee,h as te,f as se,P as O,c as ae,s as re,t as ne}from"./vendor-ui-Dpa_eFEd.js";import{S as oe,A as ie,D as ce}from"./AppSidebar-BMrVA_Jp.js";import{C as le}from"./circle-x-Dmf2Egdb.js";import{S as de}from"./search-CHJz-TVc.js";import{F as ue}from"./filter-Cb7ugw8G.js";import{C as he}from"./calendar-DyfbDffr.js";import"./vendor-supabase-By2EX_dj.js";import"./badge-COPlmVyV.js";import"./clock-D6Y4OkTG.js";import"./download-CzdIpdYh.js";import"./useAuthenticatedUser-DxFjEeTf.js";const me=Y("CircleCheck",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);var _="Switch",[pe]=se(_),[fe,ye]=pe(_),H=n.forwardRef((a,d)=>{const{__scopeSwitch:o,name:h,checked:f,defaultChecked:y,required:g,disabled:u,value:m="on",onCheckedChange:p,...x}=a,[w,j]=n.useState(null),c=ee(d,r=>j(r)),i=n.useRef(!1),v=w?!!w.closest("form"):!0,[t=!1,s]=te({prop:f,defaultProp:y,onChange:p});return e.jsxs(fe,{scope:o,checked:t,disabled:u,children:[e.jsx(O.button,{type:"button",role:"switch","aria-checked":t,"aria-required":g,"data-state":V(t),"data-disabled":u?"":void 0,disabled:u,value:m,...x,ref:c,onClick:ae(a.onClick,r=>{s(C=>!C),v&&(i.current=r.isPropagationStopped(),i.current||r.stopPropagation())})}),v&&e.jsx(ge,{control:w,bubbles:!i.current,name:h,value:m,checked:t,required:g,disabled:u,style:{transform:"translateX(-100%)"}})]})});H.displayName=_;var B="SwitchThumb",z=n.forwardRef((a,d)=>{const{__scopeSwitch:o,...h}=a,f=ye(B,o);return e.jsx(O.span,{"data-state":V(f.checked),"data-disabled":f.disabled?"":void 0,...h,ref:d})});z.displayName=B;var ge=a=>{const{control:d,checked:o,bubbles:h=!0,...f}=a,y=n.useRef(null),g=re(o),u=ne(d);return n.useEffect(()=>{const m=y.current,p=window.HTMLInputElement.prototype,w=Object.getOwnPropertyDescriptor(p,"checked").set;if(g!==o&&w){const j=new Event("click",{bubbles:h});w.call(m,o),m.dispatchEvent(j)}},[g,o,h]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:o,...f,tabIndex:-1,ref:y,style:{...a.style,...u,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function V(a){return a?"checked":"unchecked"}var $=H,xe=z;const J=n.forwardRef(({className:a,...d},o)=>e.jsx($,{className:E("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...d,ref:o,children:e.jsx(xe,{className:E("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));J.displayName=$.displayName;function we({unitId:a,amount:d}){const[o,h]=n.useState(!1),[f,y]=n.useState(!1),[g,u]=n.useState(!1),[m,p]=n.useState(null),x=K(),w=n.useCallback(async()=>{try{const{data:{session:t},error:s}=await l.auth.getSession();if(s)throw console.error("Auth error:",s),s;if(!t){b.error("Please login to make a payment"),x("/auth");return}const{data:{user:r},error:C}=await l.auth.getUser();if(C||!r){console.error("User verification error:",C),await l.auth.signOut(),x("/auth");return}y(!0)}catch(t){console.error("Auth error:",t),b.error("Authentication error. Please login again."),x("/auth")}},[x]),j=n.useCallback(async()=>{try{const{data:{user:t}}=await l.auth.getUser();if(!t)return;const{data:s,error:r}=await l.from("automatic_payments").select("is_enabled").eq("tenant_id",t.id).eq("unit_id",a).single();if(r)throw r;u(s?.is_enabled||!1)}catch(t){console.error("Error checking autopay status:",t)}},[a]),c=n.useCallback(async()=>{try{const{data:{user:t}}=await l.auth.getUser();if(!t)return;const{data:s,error:r}=await l.from("tenant_units").select(`
          unit:units (
            monthly_rent
          )
        `).eq("tenant_id",t.id).eq("unit_id",a).eq("status","active").single();if(r){console.error("Error fetching lease:",r);return}s?.unit?.monthly_rent?p(s.unit.monthly_rent):p(d||0)}catch(t){console.error("Error fetching monthly rent:",t),b.error("Failed to fetch monthly rent amount")}},[a,d]);n.useEffect(()=>{w(),j(),c()},[w,j,c]);const i=async()=>{try{const{data:{user:t}}=await l.auth.getUser();if(!t)return;const s=!g,{error:r}=await l.from("automatic_payments").upsert({tenant_id:t.id,unit_id:a,is_enabled:s},{onConflict:"tenant_id,unit_id"});if(r)throw r;u(s),b.success(s?"Automatic payments enabled":"Automatic payments disabled")}catch(t){console.error("Error toggling autopay:",t),b.error("Failed to update automatic payment settings")}},v=async()=>{if(!f){b.error("Please login to make a payment"),x("/auth");return}if(!m){b.error("Unable to process payment. Monthly rent amount not found.");return}try{h(!0);const{data:{session:t}}=await l.auth.getSession();if(!t)throw new Error("No active session");const s=await l.functions.invoke("create-checkout-session",{body:{amount:m,unit_id:a,setup_future_payments:g}});if(s.error)throw new Error(s.error.message);const{url:r}=s.data;r&&(window.location.href=r)}catch(t){console.error("Payment error:",t),(t instanceof Error?t.message:"Unknown error").includes("No active session")?(b.error("Your session has expired. Please login again."),x("/auth")):b.error("Failed to initiate payment")}finally{h(!1)}};return e.jsxs(R,{children:[e.jsxs(T,{children:[e.jsx(D,{children:"Make a Payment"}),e.jsx(G,{children:"Secure payment processing powered by Stripe"})]}),e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"amount",children:"Monthly Rent Amount"}),e.jsx(U,{id:"amount",value:m||0,readOnly:!0,type:"number",className:"bg-muted"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(J,{id:"autopay",checked:g,onCheckedChange:i}),e.jsx(M,{htmlFor:"autopay",children:"Enable automatic monthly payments"})]})]}),e.jsx(Z,{children:e.jsx(Q,{onClick:v,disabled:o||!f||!m,className:"w-full",children:o?"Processing...":`Pay $${m||0}`})})]})}const Re=()=>{const[a]=X(),d=a.get("success"),o=a.get("canceled"),[h,f]=n.useState(""),[y,g]=n.useState("all"),[u,m]=n.useState("all"),{data:p}=N({queryKey:["userRole"],queryFn:async()=>{const{data:{user:c}}=await l.auth.getUser();if(!c)throw new Error("No user found");const{data:i}=await l.from("profiles").select("role").eq("id",c.id).single();let v=null;if(i?.role==="tenant"){const{data:t}=await l.from("tenant_units").select(`
            unit_id,
            unit:units (id, unit_number, monthly_rent)
          `).eq("tenant_id",c.id).eq("status","active").maybeSingle();v=t?.unit}return{role:i?.role,activeUnit:v}}});n.useEffect(()=>{d&&b.success("Payment successful!"),o&&b.error("Payment canceled.")},[d,o]);const{data:x,isLoading:w}=N({queryKey:["payments",y,u],queryFn:async()=>{const{data:{user:c}}=await l.auth.getUser();if(!c)throw new Error("No user found");let i=l.from("rent_payments").select(`
          id,
          amount,
          payment_date,
          status,
          payment_method,
          invoice_number,
          unit:units(
            unit_number,
            property_id
          )
        `);if(p?.role==="tenant"&&(i=i.eq("tenant_id",c.id)),y!=="all"&&(i=i.eq("status",y)),u==="thisMonth"){const s=new Date;s.setDate(1),i=i.gte("payment_date",s.toISOString())}else if(u==="lastMonth"){const s=new Date;s.setMonth(s.getMonth()-1),s.setDate(1);const r=new Date;r.setDate(0),i=i.gte("payment_date",s.toISOString()).lte("payment_date",r.toISOString())}console.log("Fetching payments for user:",c.id);const{data:v,error:t}=await i.order("payment_date",{ascending:!1});if(t)throw console.error("Error fetching payments:",t),t;return console.log("Fetched payments:",v),v}}),j=x?.filter(c=>c.unit.unit_number.toLowerCase().includes(h.toLowerCase())||c.status.toLowerCase().includes(h.toLowerCase()));return w?e.jsx("div",{children:"Loading..."}):e.jsx(oe,{children:e.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[e.jsx(ie,{}),e.jsxs("div",{className:"flex-1 p-4 sm:p-6 space-y-4 sm:space-y-6",children:[d&&e.jsxs(k,{className:"bg-green-500/15 text-green-500 border-green-500/50",children:[e.jsx(me,{className:"h-4 w-4"}),e.jsx(P,{children:"Payment successful! Your payment has been processed."})]}),o&&e.jsxs(k,{className:"bg-red-500/15 text-red-500 border-red-500/50",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(P,{children:"Payment was canceled. Please try again if you wish to complete the payment."})]}),p?.role==="tenant"&&p.activeUnit&&e.jsx(we,{unitId:p.activeUnit.id,amount:p.activeUnit.monthly_rent}),e.jsxs(R,{children:[e.jsx(T,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5"}),"Payments"]})}),e.jsx(I,{className:"space-y-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[200px] relative",children:e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground"}),e.jsx(U,{placeholder:"Search payments...",value:h,onChange:c=>f(c.target.value),className:"pl-9 w-full"})]})}),e.jsxs(F,{value:y,onValueChange:g,children:[e.jsxs(A,{className:"w-full sm:w-[180px]",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),e.jsx(q,{placeholder:"Filter by status"})]}),e.jsxs(L,{children:[e.jsx(S,{value:"all",children:"All Status"}),e.jsx(S,{value:"pending",children:"Pending"}),e.jsx(S,{value:"paid",children:"Paid"}),e.jsx(S,{value:"failed",children:"Failed"})]})]}),e.jsxs(F,{value:u,onValueChange:m,children:[e.jsxs(A,{className:"w-full sm:w-[180px]",children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),e.jsx(q,{placeholder:"Filter by date"})]}),e.jsxs(L,{children:[e.jsx(S,{value:"all",children:"All Time"}),e.jsx(S,{value:"thisMonth",children:"This Month"}),e.jsx(S,{value:"lastMonth",children:"Last Month"})]})]})]}),j&&j.length>0?e.jsx(W,{payments:j}):e.jsx(k,{children:e.jsxs(P,{children:["No payments found. ",p?.role==="tenant"&&"Use the payment form above to make a payment."]})})]})})]})]})]})})};export{Re as default};
