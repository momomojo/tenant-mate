import{u as $,b as M,c as k,j as e}from"./vendor-query-BBSsXiBS.js";import{u as ne,a as x}from"./vendor-react-Cua_SOQ2.js";import{s as m,u as ae,a as ie,b as p,L as v,C as A,S as h,d as j,e as g,f,g as o,I as le,B as z,x as re,z as y}from"./index-De75nt2H.js";import{u as ce,S as oe}from"./useProperties-CW1cgYmm.js";import{u as de}from"./useUnits-BY5QSTqu.js";import{S as ue,A as pe,f as T,F as me,H as xe,d as he}from"./AppSidebar-BMrVA_Jp.js";import{T as je}from"./TopBar-ioa75gCp.js";import{T as ge}from"./textarea-BksRswRQ.js";import{B as H}from"./badge-COPlmVyV.js";import{C as N,a as b,b as _,c as C,d as fe}from"./card-nJjNL--Z.js";import{D as ye,a as Ne,b as ve,c as be,d as _e}from"./dialog-CU0zoF6x.js";import{T as Ce,A as we,a as Se,b as Ie,c as De,d as qe,e as Ae,f as Te,g as Fe}from"./alert-dialog-CYp6Xfqu.js";import{S as Me}from"./useAuthenticatedUser-DxFjEeTf.js";import{P as ke}from"./plus-CuU8l0SB.js";import{C as L}from"./clock-D6Y4OkTG.js";import{C as Pe}from"./circle-check-big-Cj9dHWRz.js";import{F as Oe}from"./filter-Cb7ugw8G.js";import{C as Ue}from"./calendar-DyfbDffr.js";import{f as w}from"./format-BJjq1L2l.js";import"./vendor-ui-Dpa_eFEd.js";import"./vendor-supabase-By2EX_dj.js";import"./scroll-area-DovF1kS9.js";const F={move_in:{label:"Move-In",color:"bg-green-600"},move_out:{label:"Move-Out",color:"bg-red-600"},routine:{label:"Routine",color:"bg-blue-600"},maintenance:{label:"Maintenance",color:"bg-yellow-600"},annual:{label:"Annual",color:"bg-purple-600"}},R={scheduled:{label:"Scheduled",color:"bg-blue-600"},in_progress:{label:"In Progress",color:"bg-yellow-600"},completed:{label:"Completed",color:"bg-green-600"},cancelled:{label:"Cancelled",color:"bg-gray-600"}};function Ee(a){return $({queryKey:["inspections",a],queryFn:async()=>{let t=m.from("inspections").select(`
          *,
          property:properties(id, name, address),
          unit:units(id, unit_number),
          tenant:profiles!inspections_tenant_id_fkey(id, first_name, last_name, email)
        `).order("scheduled_date",{ascending:!1});a?.propertyId&&(t=t.eq("property_id",a.propertyId)),a?.unitId&&(t=t.eq("unit_id",a.unitId)),a?.type&&(t=t.eq("inspection_type",a.type)),a?.status&&(t=t.eq("status",a.status));const{data:i,error:l}=await t;if(l)throw l;return i}})}function Ve(){const a=M();return k({mutationFn:async t=>{const{data:i}=await m.auth.getUser(),{data:l,error:r}=await m.from("inspections").insert({...t,created_by:i.user?.id}).select().single();if(r)throw r;return l},onSuccess:()=>{a.invalidateQueries({queryKey:["inspections"]})}})}function Be(){const a=M();return k({mutationFn:async({id:t,...i})=>{const{data:l,error:r}=await m.from("inspections").update(i).eq("id",t).select().single();if(r)throw r;return l},onSuccess:(t,i)=>{a.invalidateQueries({queryKey:["inspections"]}),a.invalidateQueries({queryKey:["inspection",i.id]})}})}function Ke(){const a=M();return k({mutationFn:async t=>{const{error:i}=await m.from("inspections").delete().eq("id",t);if(i)throw i},onSuccess:()=>{a.invalidateQueries({queryKey:["inspections"]})}})}function Qe(a){return $({queryKey:["inspectionCounts",a],queryFn:async()=>{let t=m.from("inspections").select("status");a&&(t=t.eq("property_id",a));const{data:i,error:l}=await t;if(l)throw l;const r={total:i?.length||0,scheduled:0,in_progress:0,completed:0,cancelled:0};return i?.forEach(d=>{const u=d.status;u in r&&r[u]++}),r}})}const ze=y.object({property_id:y.string().min(1,"Property is required"),unit_id:y.string().min(1,"Unit is required"),inspection_type:y.string().min(1,"Type is required"),scheduled_date:y.string().min(1,"Date is required"),inspector_notes:y.string().optional()});function ps(){const a=ne(),{toast:t}=ae(),[i,l]=x.useState({}),[r,d]=x.useState(!1),[u,I]=x.useState(null),[G,D]=x.useState(!1),[P,O]=x.useState(null),{data:U,isLoading:J}=Ee(i),{data:E}=ce(),{data:S}=Qe(i.propertyId),{mutate:W,isPending:X}=Ve(),{mutate:V,isPending:Y}=Be(),{mutate:Z}=Ke(),c=ie({resolver:re(ze),defaultValues:{property_id:"",unit_id:"",inspection_type:"",scheduled_date:w(new Date,"yyyy-MM-dd"),inspector_notes:""}}),B=c.watch("property_id"),{data:ee}=de(B||void 0);x.useEffect(()=>{(async()=>{const{data:{session:n}}=await m.auth.getSession();n||a("/auth",{replace:!0})})()},[a]);const K=s=>{s?(I(s),c.reset({property_id:s.property_id,unit_id:s.unit_id,inspection_type:s.inspection_type,scheduled_date:s.scheduled_date||w(new Date,"yyyy-MM-dd"),inspector_notes:s.inspector_notes||""})):(I(null),c.reset({property_id:i.propertyId||"",unit_id:"",inspection_type:"",scheduled_date:w(new Date,"yyyy-MM-dd"),inspector_notes:""})),d(!0)},se=s=>{u?V({id:u.id,...s,inspection_type:s.inspection_type},{onSuccess:()=>{t({title:"Inspection updated"}),d(!1),I(null)},onError:()=>{t({title:"Failed to update inspection",variant:"destructive"})}}):W({...s,inspection_type:s.inspection_type},{onSuccess:()=>{t({title:"Inspection scheduled"}),d(!1)},onError:()=>{t({title:"Failed to schedule inspection",variant:"destructive"})}})},te=()=>{P&&Z(P,{onSuccess:()=>{t({title:"Inspection deleted"}),D(!1),O(null)},onError:()=>{t({title:"Failed to delete inspection",variant:"destructive"})}})},Q=(s,n)=>{V({id:s,status:n,completed_date:n==="completed"?w(new Date,"yyyy-MM-dd"):void 0},{onSuccess:()=>{t({title:`Inspection marked as ${n}`})}})};return e.jsxs(ue,{children:[e.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[e.jsx(pe,{}),e.jsxs("main",{className:"flex-1 overflow-auto",children:[e.jsx(je,{}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Inspections"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage property condition reports and inspections"})]}),e.jsxs(ye,{open:r,onOpenChange:d,children:[e.jsx(Ne,{asChild:!0,children:e.jsxs(p,{onClick:()=>K(),children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Schedule Inspection"]})}),e.jsxs(ve,{className:"max-w-lg",children:[e.jsx(be,{children:e.jsx(_e,{children:u?"Edit Inspection":"Schedule Inspection"})}),e.jsxs("form",{onSubmit:c.handleSubmit(se),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Property *"}),e.jsx(A,{name:"property_id",control:c.control,render:({field:s})=>e.jsxs(h,{value:s.value,onValueChange:n=>{s.onChange(n),c.setValue("unit_id","")},children:[e.jsx(j,{children:e.jsx(g,{placeholder:"Select property"})}),e.jsx(f,{children:E?.map(n=>e.jsx(o,{value:n.id,children:n.name},n.id))})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Unit *"}),e.jsx(A,{name:"unit_id",control:c.control,render:({field:s})=>e.jsxs(h,{value:s.value,onValueChange:s.onChange,disabled:!B,children:[e.jsx(j,{children:e.jsx(g,{placeholder:"Select unit"})}),e.jsx(f,{children:ee?.map(n=>e.jsxs(o,{value:n.id,children:["Unit ",n.unit_number]},n.id))})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Inspection Type *"}),e.jsx(A,{name:"inspection_type",control:c.control,render:({field:s})=>e.jsxs(h,{value:s.value,onValueChange:s.onChange,children:[e.jsx(j,{children:e.jsx(g,{placeholder:"Select type"})}),e.jsx(f,{children:Object.entries(F).map(([n,q])=>e.jsx(o,{value:n,children:q.label},n))})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Scheduled Date *"}),e.jsx(le,{type:"date",...c.register("scheduled_date")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{children:"Notes"}),e.jsx(ge,{placeholder:"Any notes for this inspection...",...c.register("inspector_notes")})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(p,{type:"button",variant:"outline",onClick:()=>d(!1),children:"Cancel"}),e.jsxs(p,{type:"submit",disabled:X||Y,children:[u?"Update":"Schedule"," Inspection"]})]})]})]})]})]}),e.jsxs("div",{className:"grid gap-4 grid-cols-2 md:grid-cols-4",children:[e.jsxs(N,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(_,{className:"text-sm font-medium text-muted-foreground",children:"Total"})}),e.jsx(C,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-2xl font-bold",children:S?.total||0})]})})]}),e.jsxs(N,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(_,{className:"text-sm font-medium text-muted-foreground",children:"Scheduled"})}),e.jsx(C,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-2xl font-bold",children:S?.scheduled||0})]})})]}),e.jsxs(N,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(_,{className:"text-sm font-medium text-muted-foreground",children:"In Progress"})}),e.jsx(C,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4 text-yellow-600"}),e.jsx("span",{className:"text-2xl font-bold",children:S?.in_progress||0})]})})]}),e.jsxs(N,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(_,{className:"text-sm font-medium text-muted-foreground",children:"Completed"})}),e.jsx(C,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-2xl font-bold",children:S?.completed||0})]})})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Filters:"})]}),e.jsxs(h,{value:i.propertyId||"",onValueChange:s=>l({...i,propertyId:s||void 0}),children:[e.jsxs(j,{className:"w-[180px]",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),e.jsx(g,{placeholder:"All Properties"})]}),e.jsxs(f,{children:[e.jsx(o,{value:"",children:"All Properties"}),E?.map(s=>e.jsx(o,{value:s.id,children:s.name},s.id))]})]}),e.jsxs(h,{value:i.type||"",onValueChange:s=>l({...i,type:s||void 0}),children:[e.jsxs(j,{className:"w-[160px]",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),e.jsx(g,{placeholder:"All Types"})]}),e.jsxs(f,{children:[e.jsx(o,{value:"",children:"All Types"}),Object.entries(F).map(([s,n])=>e.jsx(o,{value:s,children:n.label},s))]})]}),e.jsxs(h,{value:i.status||"",onValueChange:s=>l({...i,status:s||void 0}),children:[e.jsxs(j,{className:"w-[160px]",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),e.jsx(g,{placeholder:"All Statuses"})]}),e.jsxs(f,{children:[e.jsx(o,{value:"",children:"All Statuses"}),Object.entries(R).map(([s,n])=>e.jsx(o,{value:s,children:n.label},s))]})]})]}),J?e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[1,2,3].map(s=>e.jsx(Me,{className:"h-48"},s))}):U?.length===0?e.jsxs(N,{className:"p-12 text-center",children:[e.jsx(T,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("h3",{className:"text-lg font-medium",children:"No inspections found"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Schedule your first inspection to start tracking property conditions"})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:U?.map(s=>{const n=F[s.inspection_type],q=R[s.status];return e.jsxs(N,{className:"hover:shadow-md transition-shadow",children:[e.jsx(b,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs(_,{className:"text-base flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4"}),s.property?.name]}),e.jsxs(fe,{className:"flex items-center gap-2 mt-1",children:[e.jsx(xe,{className:"h-3 w-3"}),"Unit ",s.unit?.unit_number]})]}),e.jsxs("div",{className:"flex flex-col gap-1 items-end",children:[e.jsx(H,{className:`${n?.color} text-white`,children:n?.label}),e.jsx(H,{variant:"outline",className:"text-xs",children:q?.label})]})]})}),e.jsxs(C,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ue,{className:"h-4 w-4"}),s.scheduled_date?w(new Date(s.scheduled_date),"MMM d, yyyy"):"Not scheduled"]}),s.tenant&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(he,{className:"h-4 w-4"}),s.tenant.first_name," ",s.tenant.last_name]}),s.inspector_notes&&e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.inspector_notes}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[s.status==="scheduled"&&e.jsx(p,{variant:"outline",size:"sm",onClick:()=>Q(s.id,"in_progress"),children:"Start"}),s.status==="in_progress"&&e.jsx(p,{variant:"outline",size:"sm",onClick:()=>Q(s.id,"completed"),children:"Complete"}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>K(s),children:e.jsx(oe,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>{O(s.id),D(!0)},children:e.jsx(Ce,{className:"h-4 w-4 text-red-500"})})]})]})]},s.id)})})]})]})]}),e.jsx(we,{open:G,onOpenChange:D,children:e.jsxs(Se,{children:[e.jsxs(Ie,{children:[e.jsx(De,{children:"Delete Inspection"}),e.jsx(qe,{children:"Are you sure you want to delete this inspection? This action cannot be undone."})]}),e.jsxs(Ae,{children:[e.jsx(Te,{children:"Cancel"}),e.jsx(Fe,{onClick:te,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})}export{ps as default};
