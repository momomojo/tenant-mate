import{j as e,u as h,b as J}from"./vendor-query-BBSsXiBS.js";import{a as $,u as V}from"./vendor-react-Cua_SOQ2.js";import{c as A,m as D,s as u,J as S,W as j,B as k,U as E}from"./index-De75nt2H.js";import{D as U,q as g,S as W,A as G,H as T,F as X,U as M,a as P,b as q,c as m,O as F,P as Z}from"./AppSidebar-BMrVA_Jp.js";import{B as ee,T as te}from"./TopBar-ioa75gCp.js";import{u as ne}from"./useAuthenticatedUser-DxFjEeTf.js";import"./vendor-ui-Dpa_eFEd.js";import"./vendor-supabase-By2EX_dj.js";import"./scroll-area-DovF1kS9.js";const re=A("CalendarClock",[["path",{d:"M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5",key:"1osxxc"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M3 10h5",key:"r794hk"}],["path",{d:"M17.5 17.5 16 16.3V14",key:"akvzfd"}],["circle",{cx:"16",cy:"16",r:"6",key:"qoo3c4"}]]);const ae=A("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]);const se=A("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),K=["from-brand-indigo/20 to-brand-indigo/5","from-brand-purple/20 to-brand-purple/5","from-status-success/20 to-status-success/5","from-brand-blue/20 to-brand-blue/5","from-status-warning/20 to-status-warning/5","from-pink-500/20 to-pink-500/5"],ie=["text-brand-indigo-light","text-brand-purple-light","text-status-success","text-brand-blue","text-status-warning","text-pink-400"],oe=({title:r,value:t,icon:s,description:o,trend:l,trendUp:a,index:c=0})=>{const d=c%K.length,p=K[d],w=ie[d];return e.jsx(D.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{duration:.3,delay:c*.05},className:"group",children:e.jsxs("div",{className:"relative overflow-hidden rounded-2xl bg-white/[0.04] border border-white/[0.08] p-5 hover:bg-white/[0.06] hover:border-white/[0.12] transition-all duration-300 card-hover-lift",children:[e.jsx("div",{className:`absolute inset-0 bg-gradient-to-br ${p} opacity-50`}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider line-clamp-1",children:r}),e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-xl bg-white/[0.06] border border-white/[0.08] group-hover:border-white/[0.12] transition-colors duration-300",children:e.jsx(s,{className:`h-4 w-4 ${w}`})})]}),e.jsx("div",{className:"text-2xl sm:text-3xl font-bold text-white tracking-tight line-clamp-1 mb-1",children:t}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-1",children:o}),e.jsx("span",{className:`inline-flex items-center gap-1 text-[10px] font-medium px-1.5 py-0.5 rounded-full ${a?"text-status-success bg-status-success/10":"text-status-error bg-status-error/10"}`,children:l})]})]})]})})};function ce(){const{data:r}=h({queryKey:["active-leases"],queryFn:async()=>{const{data:{user:o}}=await u.auth.getUser();if(!o)throw new Error("No user found");const{data:l,error:a}=await u.from("tenant_units").select(`
          unit_id,
          unit:units (
            unit_number,
            monthly_rent,
            property_id
          )
        `).eq("tenant_id",o.id).eq("status","active");if(a)throw a;return l}}),{data:t}=h({queryKey:["late-fees",r],enabled:!!r?.length,queryFn:async()=>{if(!r)return[];const o=r.map(async l=>{const{data:a,error:c}=await u.rpc("calculate_late_fee",{payment_amount:l.unit.monthly_rent,due_date:new Date().toISOString(),property_id:l.unit.property_id});if(c)throw c;return{unitNumber:l.unit.unit_number,lateFee:a}});return Promise.all(o)}}),s=t?.some(o=>o.lateFee>0);return e.jsxs(D.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{duration:.3,delay:.2},className:"space-y-4",children:[s&&e.jsxs("div",{className:"flex items-center gap-3 p-4 rounded-xl bg-status-error/10 border border-status-error/20",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-lg bg-status-error/20",children:e.jsx(se,{className:"h-4 w-4 text-status-error"})}),e.jsx("p",{className:"text-sm text-status-error font-medium",children:"You have pending late fees. Please check your payment status."})]}),e.jsxs("div",{className:"rounded-2xl bg-white/[0.04] border border-white/[0.08] overflow-hidden",children:[e.jsx("div",{className:"px-5 py-4 border-b border-white/[0.06]",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4 text-brand-indigo-light"}),e.jsx("h3",{className:"text-sm font-semibold text-white",children:"Payment Alerts"})]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[t?.map((o,l)=>o.lateFee>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-xl bg-white/[0.03] border border-white/[0.06] hover:bg-white/[0.05] transition-colors duration-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-lg bg-status-warning/10",children:e.jsx(re,{className:"h-4 w-4 text-status-warning"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-white",children:["Unit ",o.unitNumber]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Late Fee: $",o.lateFee]})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-status-warning bg-status-warning/10 px-2 py-1 rounded-full",children:[e.jsx(U,{className:"h-3 w-3"}),e.jsx("span",{children:o.lateFee})]})]},l)),!s&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-xl bg-status-success/10 mb-3",children:e.jsx(U,{className:"h-5 w-5 text-status-success"})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No pending late fees"}),e.jsx("p",{className:"text-xs text-muted-foreground/60 mt-0.5",children:"You're all caught up!"})]})]})]})]})}function de({tables:r,userId:t,onNotification:s}){const o=J();$.useEffect(()=>{if(!t)return;const l=[];return r.forEach(a=>{const c=u.channel(`${a}-changes-${t}`).on("postgres_changes",{event:"*",schema:"public",table:a,filter:le(a,t)},d=>{if(ue(o,a),a==="notifications"&&d.eventType==="INSERT"){s&&s(d.new);const p=d.new;p?.title&&S(p.title,{description:p.message})}}).subscribe();l.push(c)}),()=>{l.forEach(a=>{u.removeChannel(a)})}},[r,t,o,s])}function le(r,t){switch(r){case"notifications":return`user_id=eq.${t}`;case"maintenance_requests":return`tenant_id=eq.${t}`;case"rent_payments":return`tenant_id=eq.${t}`;case"tenant_units":return`tenant_id=eq.${t}`;default:return}}function ue(r,t,s){switch(t){case"notifications":r.invalidateQueries({queryKey:["notifications"]});break;case"maintenance_requests":r.invalidateQueries({queryKey:["maintenanceRequests"]}),r.invalidateQueries({queryKey:["tenantMaintenanceCount"]}),r.invalidateQueries({queryKey:["pmDashboardStats"]});break;case"rent_payments":r.invalidateQueries({queryKey:["payments"]}),r.invalidateQueries({queryKey:["rentRoll"]}),r.invalidateQueries({queryKey:["incomeReport"]});break;case"tenant_units":r.invalidateQueries({queryKey:["tenantUnits"]}),r.invalidateQueries({queryKey:["pmDashboardStats"]});break;case"properties":r.invalidateQueries({queryKey:["properties"]}),r.invalidateQueries({queryKey:["pmDashboardStats"]}),r.invalidateQueries({queryKey:["propertySummary"]});break;case"units":r.invalidateQueries({queryKey:["units"]}),r.invalidateQueries({queryKey:["pmDashboardStats"]}),r.invalidateQueries({queryKey:["rentRoll"]});break}}function pe(r){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:2}).format(r)}const Ne=()=>{const r=V(),{user:t}=ne();de({tables:["notifications","maintenance_requests","tenant_units","rent_payments"],userId:t?.id});const{data:s,isError:o,isLoading:l}=h({queryKey:g.userRole(t?.id),queryFn:async()=>{if(!t)throw new Error("No user found");const{data:n,error:i}=await u.from("profiles").select("role").eq("id",t.id).single();if(i)throw i;return n?.role},enabled:!!t}),{data:a}=h({queryKey:g.dashboard.pmStats(t?.id),queryFn:async()=>{if(!t)throw new Error("No user found");const{data:n,error:i}=await u.from("properties").select(`
          id,
          units (
            id,
            status,
            tenant_units (
              id,
              status
            )
          )
        `).or(`created_by.eq.${t.id},property_manager_id.eq.${t.id}`);if(i)throw i;const y=n?.length||0,f=n?.reduce((v,b)=>v+(b.units?.length||0),0)||0,x=n?.reduce((v,b)=>v+(b.units?.filter(_=>_.status==="occupied").length||0),0)||0,H=n?.reduce((v,b)=>v+(b.units?.reduce((_,z)=>_+(z.tenant_units?.filter(I=>I.status==="active").length||0),0)||0),0)||0,{count:Y}=await u.from("maintenance_requests").select("*",{count:"exact",head:!0}).in("status",F);return{totalProperties:y,totalUnits:f,activeTenants:H,openMaintenance:Y||0,occupiedUnits:x}},enabled:s===m.propertyManager||s===m.admin}),{data:c}=h({queryKey:g.dashboard.applicantStats(t?.id),queryFn:async()=>{if(!t)throw new Error("No user found");const{data:n,error:i}=await u.from("applicants").select(`
          status,
          property:properties!inner(created_by, property_manager_id)
        `).or(`property.created_by.eq.${t.id},property.property_manager_id.eq.${t.id}`);if(i)return{total:0,pending:0};const y=n?.filter(f=>Z.includes(f.status)).length||0;return{total:n?.length||0,pending:y}},enabled:s===m.propertyManager||s===m.admin}),{data:d}=h({queryKey:g.dashboard.leaseStats(t?.id),queryFn:async()=>{if(!t)throw new Error("No user found");const{data:n,error:i}=await u.from("leases").select(`
          status,
          property:properties!inner(created_by, property_manager_id)
        `).or(`property.created_by.eq.${t.id},property.property_manager_id.eq.${t.id}`);if(i)return{total:0,active:0,pending:0};const y=n?.filter(x=>x.status==="active").length||0,f=n?.filter(x=>["draft","pending"].includes(x.status)).length||0;return{total:n?.length||0,active:y,pending:f}},enabled:s===m.propertyManager||s===m.admin}),{data:p,isError:w}=h({queryKey:g.tenants.units(t?.id),queryFn:async()=>{if(!t)throw new Error("No user found");const{data:n,error:i}=await u.from("tenant_units").select(`
          unit_id,
          status,
          units (
            unit_number,
            monthly_rent
          )
        `).eq("tenant_id",t.id).eq("status","active");if(i)throw i;return n},enabled:s===m.tenant}),{data:N}=h({queryKey:g.tenants.maintenanceCount(t?.id),queryFn:async()=>{if(!t)throw new Error("No user found");const{count:n,error:i}=await u.from("maintenance_requests").select("*",{count:"exact",head:!0}).eq("tenant_id",t.id).in("status",F);if(i)throw i;return n||0},enabled:s===m.tenant}),{data:Q}=h({queryKey:g.tenants.documentsCount(t?.id),queryFn:async()=>{if(!t)throw new Error("No user found");const{count:n,error:i}=await u.from("document_access_view").select("*",{count:"exact",head:!0});return i?0:n||0},enabled:s===m.tenant});if($.useEffect(()=>{(async()=>{const{data:{session:i}}=await u.auth.getSession();i||r("/auth")})()},[r]),l)return e.jsx("div",{className:"flex min-h-screen items-center justify-center bg-background",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full border-2 border-brand-indigo/20 border-t-brand-indigo animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading dashboard..."})]})});if(o)return S.error("Error loading dashboard. Please try again."),null;w&&S.error("Error loading tenant information. Please try again.");const R=()=>p?p.reduce((n,i)=>n+(i.units?.monthly_rent||0),0):0,L=()=>p?p.map(n=>n.units?.unit_number).filter(Boolean).join(", "):"",C=()=>{const n=a?.totalUnits?Math.round(a.occupiedUnits/a.totalUnits*100):0;switch(s){case"property_manager":return[{title:"Total Properties",value:String(a?.totalProperties||0),icon:k,description:"Properties under management",trend:"Active",trendUp:!0},{title:"Total Units",value:String(a?.totalUnits||0),icon:T,description:`${a?.occupiedUnits||0} occupied`,trend:`${n}% occupancy`,trendUp:n>=q},{title:"Applicants",value:String(c?.total||0),icon:M,description:`${c?.pending||0} pending review`,trend:c?.pending?"Needs attention":"All reviewed",trendUp:!c?.pending},{title:"Leases",value:String(d?.active||0),icon:P,description:`${d?.pending||0} pending signature`,trend:d?.pending?"Action needed":"All signed",trendUp:!d?.pending},{title:"Active Tenants",value:String(a?.activeTenants||0),icon:E,description:"Current tenants",trend:"Active",trendUp:!0},{title:"Maintenance",value:String(a?.openMaintenance||0),icon:j,description:"Open requests",trend:a?.openMaintenance===0?"All clear":"Pending",trendUp:a?.openMaintenance===0}];case"admin":return[{title:"Total Properties",value:String(a?.totalProperties||0),icon:k,description:"Properties in system",trend:"Active",trendUp:!0},{title:"Occupancy Rate",value:`${n}%`,icon:ae,description:`${a?.occupiedUnits||0}/${a?.totalUnits||0} units`,trend:n>=q?"Healthy":"Below target",trendUp:n>=q},{title:"Applicants",value:String(c?.total||0),icon:M,description:`${c?.pending||0} pending review`,trend:c?.pending?"Needs attention":"All reviewed",trendUp:!c?.pending},{title:"Leases",value:String(d?.active||0),icon:P,description:`${d?.pending||0} pending signature`,trend:d?.pending?"Action needed":"All signed",trendUp:!d?.pending},{title:"Active Tenants",value:String(a?.activeTenants||0),icon:E,description:"Total tenants",trend:"Active",trendUp:!0},{title:"Maintenance",value:String(a?.openMaintenance||0),icon:j,description:"Open requests",trend:a?.openMaintenance===0?"All clear":"Pending",trendUp:a?.openMaintenance===0}];case"tenant":return[{title:"My Units",value:L()||"None",icon:T,description:p?.length?"Current unit numbers":"No units assigned",trend:p?.length?"Active":"Contact manager",trendUp:!!p?.length},{title:"Rent Due",value:pe(R()),icon:U,description:"Due on 1st of month",trend:"Monthly",trendUp:!0},{title:"Maintenance",value:String(N||0),icon:j,description:"Active requests",trend:N===0?"All clear":"In progress",trendUp:N===0},{title:"Documents",value:String(Q||0),icon:X,description:"Your documents",trend:"Available",trendUp:!0}];default:return[]}},O=()=>s==="tenant"?"My Dashboard":s==="property_manager"?"Property Manager Dashboard":"Admin Dashboard",B=()=>s==="tenant"?"Overview of your rental information":s==="property_manager"?"Overview of your property portfolio":"System-wide performance overview";return e.jsx(W,{children:e.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[e.jsx(G,{}),e.jsx("main",{className:"flex-1 p-4 sm:p-8 overflow-x-hidden",children:e.jsxs("div",{className:"flex flex-col gap-6 sm:gap-8",children:[e.jsx(te,{title:O(),subtitle:B()}),e.jsx("div",{className:"grid gap-4 sm:gap-5 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",children:C().map((n,i)=>e.jsx(oe,{...n,index:i},n.title))}),s==="tenant"&&e.jsx(ce,{})]})})]})})};export{Ne as default};
