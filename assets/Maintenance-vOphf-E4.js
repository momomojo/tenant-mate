import{b as F,u as j,c as S,j as e}from"./vendor-query-BBSsXiBS.js";import{u as L,b as q,L as m,S as y,d as f,e as b,f as w,g as i,I as E,W as I,s as o}from"./index-De75nt2H.js";import{S as K,A as k}from"./AppSidebar-BMrVA_Jp.js";import{T as A}from"./TopBar-ioa75gCp.js";import{C as H}from"./card-nJjNL--Z.js";import{D as Q,a as V,b as O,c as W,d as $}from"./dialog-CU0zoF6x.js";import{T as z}from"./textarea-BksRswRQ.js";import{T as G,a as J,b as C,c as r,d as X,e as l}from"./table-D-R88hVk.js";import{B as T}from"./badge-COPlmVyV.js";import{a as D}from"./vendor-react-Cua_SOQ2.js";import{u as Y}from"./useAuthenticatedUser-DxFjEeTf.js";import{P as Z}from"./plus-CuU8l0SB.js";import"./vendor-ui-Dpa_eFEd.js";import"./vendor-supabase-By2EX_dj.js";import"./scroll-area-DovF1kS9.js";const pe=()=>{const{toast:x}=L(),v=F(),{user:c}=Y(),[P,_]=D.useState(!1),[a,d]=D.useState({title:"",description:"",priority:"medium",unit_id:""}),{data:h}=j({queryKey:["userProfile"],queryFn:async()=>{const{data:t,error:s}=await o.from("profiles").select("role").eq("id",c?.id).single();if(s)throw s;return t},enabled:!!c}),n=h?.role==="property_manager"||h?.role==="admin",{data:p}=j({queryKey:["maintenanceUnits",c?.id],queryFn:async()=>{if(n){const{data:t,error:s}=await o.from("units").select(`
            id,
            unit_number,
            property:properties(name)
          `).order("unit_number");if(s)throw s;return t}else{const{data:t,error:s}=await o.from("tenant_units").select(`
            unit:units(
              id,
              unit_number,
              property:properties(name)
            )
          `).eq("tenant_id",c?.id).eq("status","active");if(s)throw s;return t?.map(u=>u.unit)||[]}},enabled:!!c&&h!==void 0}),{data:g,isLoading:R}=j({queryKey:["maintenanceRequests"],queryFn:async()=>{const{data:t,error:s}=await o.from("maintenance_requests").select(`
          *,
          unit:units(
            unit_number,
            property:properties(name)
          ),
          tenant:profiles!maintenance_requests_tenant_id_fkey(
            first_name,
            last_name
          )
        `).order("created_at",{ascending:!1});if(s)throw s;return t}}),N=S({mutationFn:async t=>{const{error:s}=await o.from("maintenance_requests").insert({tenant_id:c?.id,unit_id:t.unit_id,title:t.title,description:t.description,priority:t.priority});if(s)throw s},onSuccess:()=>{v.invalidateQueries({queryKey:["maintenanceRequests"]}),x({title:"Success",description:"Maintenance request submitted"}),_(!1),d({title:"",description:"",priority:"medium",unit_id:""})},onError:t=>{console.error("Error creating request:",t),x({title:"Error",description:"Failed to submit request",variant:"destructive"})}}),M=S({mutationFn:async({id:t,status:s})=>{const{error:u}=await o.from("maintenance_requests").update({status:s}).eq("id",t);if(u)throw u},onSuccess:()=>{v.invalidateQueries({queryKey:["maintenanceRequests"]}),x({title:"Success",description:"Status updated"})}}),B=t=>{const s={pending:"bg-yellow-500",in_progress:"bg-blue-500",completed:"bg-green-500",cancelled:"bg-gray-500"};return e.jsx(T,{className:`${s[t]||"bg-gray-500"} text-white`,children:t.replace("_"," ")})},U=t=>{const s={low:"bg-gray-400",medium:"bg-yellow-500",high:"bg-orange-500",urgent:"bg-red-500"};return e.jsx(T,{className:`${s[t]||"bg-gray-400"} text-white`,children:t})};return e.jsx(K,{children:e.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[e.jsx(k,{}),e.jsx("main",{className:"flex-1 p-4 sm:p-8",children:e.jsxs("div",{className:"flex flex-col gap-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsx(A,{title:"Maintenance Requests",subtitle:n?"Manage maintenance requests":"Submit and track maintenance requests"}),!n&&p&&p.length>0&&e.jsxs(Q,{open:P,onOpenChange:_,children:[e.jsx(V,{asChild:!0,children:e.jsxs(q,{children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"New Request"]})}),e.jsxs(O,{children:[e.jsx(W,{children:e.jsx($,{children:"Submit Maintenance Request"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Unit"}),e.jsxs(y,{value:a.unit_id,onValueChange:t=>d({...a,unit_id:t}),children:[e.jsx(f,{children:e.jsx(b,{placeholder:"Select unit"})}),e.jsx(w,{children:p?.map(t=>e.jsxs(i,{value:t.id,children:[t.property?.name," - Unit ",t.unit_number]},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Title"}),e.jsx(E,{value:a.title,onChange:t=>d({...a,title:t.target.value}),placeholder:"Brief description of the issue"})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Description"}),e.jsx(z,{value:a.description,onChange:t=>d({...a,description:t.target.value}),placeholder:"Detailed description of the issue",rows:4})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Priority"}),e.jsxs(y,{value:a.priority,onValueChange:t=>d({...a,priority:t}),children:[e.jsx(f,{children:e.jsx(b,{})}),e.jsxs(w,{children:[e.jsx(i,{value:"low",children:"Low"}),e.jsx(i,{value:"medium",children:"Medium"}),e.jsx(i,{value:"high",children:"High"}),e.jsx(i,{value:"urgent",children:"Urgent"})]})]})]}),e.jsx(q,{onClick:()=>N.mutate(a),disabled:!a.title||!a.unit_id||N.isPending,className:"w-full",children:"Submit Request"})]})]})]})]}),e.jsx(H,{className:"glass-card overflow-x-auto",children:R?e.jsx("div",{className:"p-8 text-center text-gray-400",children:"Loading..."}):g&&g.length>0?e.jsxs(G,{className:"min-w-[800px]",children:[e.jsx(J,{children:e.jsxs(C,{children:[e.jsx(r,{className:"text-gray-300",children:"Title"}),e.jsx(r,{className:"text-gray-300",children:"Unit"}),n&&e.jsx(r,{className:"text-gray-300",children:"Tenant"}),e.jsx(r,{className:"text-gray-300",children:"Priority"}),e.jsx(r,{className:"text-gray-300",children:"Status"}),e.jsx(r,{className:"text-gray-300",children:"Created"}),n&&e.jsx(r,{className:"text-gray-300",children:"Actions"})]})}),e.jsx(X,{children:g.map(t=>e.jsxs(C,{children:[e.jsxs(l,{className:"text-white font-medium",children:[t.title,e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:t.description})]}),e.jsxs(l,{className:"text-gray-300",children:[t.unit?.property?.name," - Unit ",t.unit?.unit_number]}),n&&e.jsxs(l,{className:"text-gray-300",children:[t.tenant?.first_name," ",t.tenant?.last_name]}),e.jsx(l,{children:U(t.priority)}),e.jsx(l,{children:B(t.status)}),e.jsx(l,{className:"text-gray-300",children:new Date(t.created_at).toLocaleDateString()}),n&&e.jsx(l,{children:e.jsxs(y,{value:t.status,onValueChange:s=>M.mutate({id:t.id,status:s}),children:[e.jsx(f,{className:"w-32",children:e.jsx(b,{})}),e.jsxs(w,{children:[e.jsx(i,{value:"pending",children:"Pending"}),e.jsx(i,{value:"in_progress",children:"In Progress"}),e.jsx(i,{value:"completed",children:"Completed"}),e.jsx(i,{value:"cancelled",children:"Cancelled"})]})]})})]},t.id))})]}):e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(I,{className:"h-12 w-12 text-gray-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"No maintenance requests yet"})]})})]})})]})})};export{pe as default};
