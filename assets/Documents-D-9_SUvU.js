import{j as e,u as h}from"./vendor-query-BBSsXiBS.js";import{a as y}from"./vendor-react-Cua_SOQ2.js";import{c as w,b as x,s as c,J as p,B as g}from"./index-De75nt2H.js";import{F as j,S as N,A as v}from"./AppSidebar-BMrVA_Jp.js";import{C as b}from"./card-nJjNL--Z.js";import{U as _}from"./upload-CtT6q7_8.js";import{D}from"./download-CzdIpdYh.js";import"./vendor-ui-Dpa_eFEd.js";import"./vendor-supabase-By2EX_dj.js";import"./useAuthenticatedUser-DxFjEeTf.js";const U=w("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]);const k=w("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]);function F({propertyId:n,onUploadComplete:u}){const[l,m]=y.useState(!1),d=async t=>{const i=t.target.files?.[0];if(i)try{m(!0);const s=i.name.split(".").pop(),r=`${n}/${crypto.randomUUID()}.${s}`,{error:o}=await c.storage.from("property_documents").upload(r,i);if(o)throw o;const{error:a}=await c.from("property_documents").insert({property_id:n,filename:i.name,file_path:r,document_type:s||"unknown",uploaded_by:(await c.auth.getUser()).data.user?.id});if(a)throw a;p.success("Document uploaded successfully"),u()}catch(s){console.error("Upload error:",s),p.error("Failed to upload document")}finally{m(!1)}};return e.jsxs("div",{children:[e.jsxs(x,{variant:"outline",className:"gap-2",disabled:l,onClick:()=>document.getElementById("fileInput")?.click(),children:[e.jsx(_,{className:"h-4 w-4"}),"Upload Document"]}),e.jsx("input",{id:"fileInput",type:"file",className:"hidden",onChange:d,accept:".pdf,.doc,.docx,.txt"})]})}function f({documents:n,showPropertyName:u=!1,showUploaderInfo:l=!1}){const m=async(t,i)=>{try{const{data:s,error:r}=await c.storage.from("property_documents").download(t);if(r)throw r;const o=URL.createObjectURL(s),a=document.createElement("a");a.href=o,a.download=i,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o)}catch(s){console.error("Download error:",s),p.error("Failed to download document")}},d=async(t,i)=>{try{const{error:s}=await c.storage.from("property_documents").remove([i]);if(s)throw s;const{error:r}=await c.from("property_documents").delete().eq("id",t);if(r)throw r;p.success("Document deleted successfully"),window.location.reload()}catch(s){console.error("Delete error:",s),p.error("Failed to delete document")}};return e.jsx("div",{className:"space-y-4",children:n.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-white/[0.04] rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{className:"h-5 w-5 text-brand-indigo-light"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white",children:t.filename}),e.jsxs("div",{className:"text-sm text-gray-400 space-y-1",children:[e.jsx("p",{children:new Date(t.created_at).toLocaleDateString()}),u&&t.property_name&&e.jsxs("p",{children:["Property: ",t.property_name]}),l&&t.uploader_first_name&&e.jsxs("p",{children:["Uploaded by: ",t.uploader_first_name," ",t.uploader_last_name]})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>m(t.file_path,t.filename),children:e.jsx(D,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>d(t.id,t.file_path),children:e.jsx(k,{className:"h-4 w-4"})})]})]},t.id))})}const B=()=>{const[n,u]=y.useState(null),{data:l}=h({queryKey:["userRole"],queryFn:async()=>{const{data:{user:r}}=await c.auth.getUser();if(!r)throw new Error("No user found");const{data:o,error:a}=await c.from("profiles").select("role").eq("id",r.id).single();if(a)throw a;return o?.role}}),{data:m}=h({queryKey:["properties"],queryFn:async()=>{const{data:r,error:o}=await c.from("properties").select("*").order("name");if(o)throw o;return r},enabled:l==="property_manager"}),{data:d,isLoading:t}=h({queryKey:["documents",n],queryFn:async()=>{let r=c.from("document_access_view").select("*");l==="property_manager"&&n&&(r=r.eq("property_id",n));const{data:o,error:a}=await r;if(a)throw p.error("Failed to fetch documents"),a;return o}}),i=()=>{switch(l){case"admin":return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),e.jsx("h2",{className:"text-xl font-semibold text-white",children:"All Documents"})]});case"property_manager":return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{className:"h-5 w-5"}),e.jsx("h2",{className:"text-xl font-semibold text-white",children:"Property Documents"})]});case"tenant":return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"h-5 w-5"}),e.jsx("h2",{className:"text-xl font-semibold text-white",children:"My Property Documents"})]});default:return null}},s=()=>t?e.jsx("div",{className:"text-gray-400",children:"Loading documents..."}):d?.length?l==="property_manager"?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("select",{className:"w-full p-2 rounded bg-white/[0.04] text-white border border-white/[0.08]",value:n||"",onChange:r=>u(r.target.value||null),children:[e.jsx("option",{value:"",children:"Select a property"}),m?.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),n&&e.jsxs(e.Fragment,{children:[e.jsx(F,{propertyId:n,onUploadComplete:()=>{window.location.reload()}}),e.jsx(f,{documents:d,showPropertyName:!1,showUploaderInfo:!0})]})]}):e.jsx(f,{documents:d,showPropertyName:l==="admin",showUploaderInfo:l==="admin"}):e.jsx("div",{className:"text-gray-400",children:"No documents found."});return e.jsx(N,{children:e.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[e.jsx(v,{}),e.jsx("main",{className:"flex-1 p-4 sm:p-8",children:e.jsxs("div",{className:"flex flex-col gap-6 sm:gap-8",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-semibold text-white",children:"Documents"}),e.jsx(b,{className:"glass-card p-4 sm:p-6",children:e.jsxs("div",{className:"space-y-6",children:[i(),s()]})})]})})]})})};export{B as default};
